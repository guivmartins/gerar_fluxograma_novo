<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxograma Interativo - Drawflow</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drawflow@0.0.60/dist/drawflow.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            color: #00796B;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #00796B;
        }

        .info h3 {
            color: #00796B;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .info ul {
            list-style-position: inside;
            color: #555;
            margin-top: 10px;
        }

        .info ul li {
            margin: 5px 0;
            padding-left: 10px;
        }

        .upload-section {
            margin: 30px 0;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 8px;
            text-align: center;
            border: 2px dashed #00796B;
        }

        .upload-section h3 {
            color: #00796B;
            margin-bottom: 15px;
        }

        input[type="file"] {
            margin: 15px 0;
            padding: 12px;
            border: 2px solid #00796B;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            max-width: 400px;
        }

        input[type="file"]:hover {
            background: #f0f9f8;
        }

        button {
            background: linear-gradient(135deg, #00796B 0%, #004D40 100%);
            color: white;
            border: none;
            padding: 14px 35px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 5px;
        }

        button:hover {
            background: linear-gradient(135deg, #006B5A 0%, #003830 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #drawflow {
            width: 100%;
            height: 700px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
            position: relative;
            background: #fafafa;
            background-image: 
                linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,.05) 1px, transparent 1px);
            background-size: 20px 20px;
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* ESTILOS OTIMIZADOS PARA DRAWFLOW */
        .drawflow .drawflow-node {
            border: 2px solid;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            min-width: 150px;
            text-align: center;
            font-weight: 500;
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
            pointer-events: auto;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* IN√çCIO E FIM COMO C√çRCULOS MENORES - 60x60px */
        .drawflow .drawflow-node.start,
        .drawflow .drawflow-node.end {
            border-radius: 50% !important;
            background: linear-gradient(135deg, #87C2BC 0%, #6BA9A3 100%);
            border-color: #00A896;
            color: #004D40;
            font-weight: bold;
            width: 60px !important;
            height: 60px !important;
            min-width: 60px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            font-size: 11px;
        }

        /* ATIVIDADES - Ret√¢ngulos arredondados */
        .drawflow .drawflow-node.activity {
            border-radius: 10px;
            background: linear-gradient(135deg, #00AE9D 0%, #008F81 100%);
            border-color: #006B5A;
            color: white;
            font-weight: bold;
        }

        /* PROCEDIMENTOS - Ret√¢ngulos */
        .drawflow .drawflow-node.procedure {
            border-radius: 10px;
            background: linear-gradient(135deg, #E8E8E8 0%, #D0D0D0 100%);
            border-color: #B0B0B0;
            color: #333;
            font-size: 13px;
        }

        /* CONECTORES CENTRALIZADOS NAS LATERAIS - Bolinhas menores (8px) */
        .drawflow .drawflow-node .input,
        .drawflow .drawflow-node .output {
            width: 8px !important;
            height: 8px !important;
            border-radius: 50%;
            background: #00796B;
            border: 2px solid white;
            position: absolute;
        }

        /* Input centralizado no MEIO da ESQUERDA */
        .drawflow .drawflow-node .input {
            left: -4px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Output centralizado no MEIO da DIREITA */
        .drawflow .drawflow-node .output {
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Hover nos conectores */
        .drawflow .drawflow-node .input:hover,
        .drawflow .drawflow-node .output:hover {
            background: #004D40;
            transform: translateY(-50%) scale(1.3);
        }

        /* Desabilitar hover pesado durante drag */
        .drawflow.dragging .drawflow-node {
            transition: none !important;
        }

        .drawflow.dragging .drawflow-node:hover {
            transform: none !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }

        .drawflow .drawflow-node:not(.dragging):hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }

        .drawflow-node.selected {
            box-shadow: 0 0 20px rgba(0,121,107,0.6);
            border-width: 3px;
        }

        /* LINHAS ORTOGONAIS (√ÇNGULO RETO) COM SETAS VERDES */
        .drawflow svg {
            will-change: transform;
            transform: translateZ(0);
        }

        .drawflow .connection .main-path {
            stroke: #00796B !important;
            stroke-width: 2.5 !important;
            fill: none;
            transition: none;
            /* Importante para linhas ortogonais */
            stroke-linecap: square;
            stroke-linejoin: miter;
        }

        .drawflow .connection {
            pointer-events: all;
        }

        .drawflow .main-path {
            marker-end: url(#arrowgreen);
        }

        #processo-nome {
            font-size: 24px;
            font-weight: bold;
            color: #00796B;
            margin: 20px 0;
            text-align: center;
            padding: 15px;
            background: #f0f9f8;
            border-radius: 8px;
            border-left: 5px solid #00796B;
            display: none;
        }

        .controls {
            margin: 20px 0;
            text-align: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            display: none;
        }

        .controls button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
            font-size: 18px;
            border: 1px solid #ffeeba;
        }

        .loading.active {
            display: block;
        }

        .loading::before {
            content: "‚è≥ ";
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #c62828;
            display: none;
        }

        .error.active {
            display: block;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #4caf50;
            display: none;
        }

        .success.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            #drawflow {
                height: 500px;
            }

            .controls button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }

            input[type="file"] {
                font-size: 12px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Gerador de Fluxograma Interativo</h1>

        <div class="info">
            <h3>üìã Colunas Obrigat√≥rias no Excel</h3>
            <p>Para gerar o fluxograma corretamente, seu arquivo Excel deve conter as seguintes colunas:</p>
            <ul>
                <li><strong>NOME PROCESSO</strong> - Nome do processo a ser mapeado</li>
                <li><strong>ATIVIDADE IN√çCIO</strong> - Indica se √© ponto inicial (SIM/N√ÉO)</li>
                <li><strong>ATIVIDADE ORIGEM</strong> - Atividade de origem no fluxo</li>
                <li><strong>PROCEDIMENTO</strong> - Descri√ß√£o do procedimento executado</li>
                <li><strong>ATIVIDADE DESTINO</strong> - Atividade de destino no fluxo</li>
            </ul>
            <p style="margin-top: 10px; font-weight: bold;">‚ö†Ô∏è Formato aceito: Apenas arquivos <strong>.xlsx</strong></p>
        </div>

        <div class="upload-section">
            <h3>üìÅ Selecione o Arquivo Excel</h3>
            <input type="file" id="excel_file" accept=".xlsx" required>
            <br>
            <button onclick="uploadFile()">üöÄ Gerar Fluxograma Interativo</button>
        </div>

        <div class="loading" id="loading">
            Processando arquivo... Por favor, aguarde.
        </div>

        <div class="error" id="error"></div>
        <div class="success" id="success"></div>

        <div id="processo-nome"></div>

        <div class="controls" id="controls">
            <button onclick="editor.zoom_in()">üîç Zoom +</button>
            <button onclick="editor.zoom_out()">üîç Zoom -</button>
            <button onclick="editor.zoom_reset()">‚Ü∫ Reset Zoom</button>
            <button onclick="exportFluxograma()">üíæ Exportar JSON</button>
            <button onclick="limparFluxograma()">üóëÔ∏è Limpar Tudo</button>
        </div>

        <div id="drawflow">
            <!-- SVG para definir a seta verde -->
            <svg style="position: absolute; width: 0; height: 0;">
                <defs>
                    <marker id="arrowgreen" markerWidth="12" markerHeight="12" 
                            refX="10" refY="6" orient="auto" markerUnits="strokeWidth">
                        <path d="M2,2 L2,10 L10,6 Z" fill="#00796B" />
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/drawflow@0.0.60/dist/drawflow.min.js"></script>
    <script>
        const drawflowContainer = document.getElementById("drawflow");
        const editor = new Drawflow(drawflowContainer);

        // CONFIGURA√á√ïES PARA LINHAS ORTOGONAIS (QUEBRAS EM √ÇNGULO RETO)
        editor.start();
        editor.editor_mode = 'edit';
        editor.reroute = true;
        editor.reroute_fix_curvature = true; // Importante para quebras
        editor.force_first_input = false;

        // ATIVAR LINHAS ORTOGONAIS - QUEBRAS EM √ÇNGULO RETO
        editor.line_path = 5; // 5 = step (linhas com quebras ortogonais)
        editor.curvature = 0; // Sem curvas

        let currentData = null;
        let isDragging = false;

        // Adicionar setas verdes √†s conex√µes
        editor.on('connectionCreated', function(connection) {
            addArrowToConnection(connection.output_id, connection.input_id);
        });

        function addArrowToConnection(outputId, inputId) {
            setTimeout(() => {
                const connections = document.querySelectorAll('.connection .main-path');
                connections.forEach(path => {
                    path.setAttribute('marker-end', 'url(#arrowgreen)');
                    path.style.stroke = '#00796B';
                    path.style.strokeWidth = '2.5';
                });
            }, 100);
        }

        // Otimizar durante drag
        editor.on('nodeSelected', function(id) {
            if (!isDragging) {
                isDragging = true;
                drawflowContainer.classList.add('dragging');
            }
        });

        editor.on('nodeUnselected', function(id) {
            if (isDragging) {
                setTimeout(() => {
                    isDragging = false;
                    drawflowContainer.classList.remove('dragging');
                }, 100);
            }
        });

        // Debounce para redraw durante movimento
        let redrawTimeout;
        editor.on('nodeMoved', function(id) {
            clearTimeout(redrawTimeout);
            redrawTimeout = setTimeout(() => {
                editor.updateConnectionNodes('node-' + id);
                // Reaplicar setas ap√≥s mover
                const connections = document.querySelectorAll('.connection .main-path');
                connections.forEach(path => {
                    path.setAttribute('marker-end', 'url(#arrowgreen)');
                    path.style.stroke = '#00796B';
                    path.style.strokeWidth = '2.5';
                });
            }, 16);
        });

        async function uploadFile() {
            const fileInput = document.getElementById('excel_file');
            const file = fileInput.files[0];
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const successEl = document.getElementById('success');

            errorEl.classList.remove('active');
            errorEl.textContent = '';
            successEl.classList.remove('active');
            successEl.textContent = '';

            if (!file) {
                showError('Por favor, selecione um arquivo Excel');
                return;
            }

            if (!file.name.endsWith('.xlsx')) {
                showError('Por favor, selecione apenas arquivos .xlsx');
                return;
            }

            const formData = new FormData();
            formData.append('excel_file', file);

            loadingEl.classList.add('active');

            try {
                const response = await fetch('/api/fluxograma', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao processar arquivo');
                }

                currentData = data;
                renderFluxograma(data);

                document.getElementById('controls').style.display = 'block';
                showSuccess('‚úì Fluxograma com linhas ortogonais (quebras em √¢ngulo reto)!');

            } catch (error) {
                showError('Erro ao gerar fluxograma: ' + error.message);
            } finally {
                loadingEl.classList.remove('active');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = '‚ùå ' + message;
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('success');
            successEl.textContent = message;
            successEl.classList.add('active');
            setTimeout(() => successEl.classList.remove('active'), 5000);
        }

        function renderFluxograma(data) {
            drawflowContainer.style.pointerEvents = 'none';
            drawflowContainer.style.opacity = '0.7';

            editor.clear();

            const nomeEl = document.getElementById('processo-nome');
            nomeEl.textContent = 'üìä ' + data.nome_processo;
            nomeEl.style.display = 'block';

            const nodeIdMap = {};

            // Adicionar todos os n√≥s
            data.nodes.forEach(node => {
                const nodeHtml = `<div>${node.name}</div>`;
                const drawflowNodeId = editor.addNode(
                    node.type,
                    1,
                    1,
                    node.pos_x,
                    node.pos_y,
                    node.type,
                    {},
                    nodeHtml,
                    false
                );

                nodeIdMap[node.id] = drawflowNodeId;
            });

            // Adicionar todas as conex√µes
            data.connections.forEach(conn => {
                const fromId = nodeIdMap[conn.from];
                const toId = nodeIdMap[conn.to];

                if (fromId && toId) {
                    editor.addConnection(fromId, toId, 'output_1', 'input_1');
                }
            });

            // Aplicar setas verdes ap√≥s renderiza√ß√£o
            setTimeout(() => {
                const connections = document.querySelectorAll('.connection .main-path');
                connections.forEach(path => {
                    path.setAttribute('marker-end', 'url(#arrowgreen)');
                    path.style.stroke = '#00796B';
                    path.style.strokeWidth = '2.5';
                });

                drawflowContainer.style.pointerEvents = 'auto';
                drawflowContainer.style.opacity = '1';

                requestAnimationFrame(() => {
                    editor.zoom_reset();
                });
            }, 100);
        }

        function exportFluxograma() {
            if (!currentData) {
                showError('Nenhum fluxograma para exportar');
                return;
            }

            const exportData = editor.export();
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'fluxograma_' + new Date().getTime() + '.json';
            link.click();

            URL.revokeObjectURL(url);
            showSuccess('‚úì Fluxograma exportado com sucesso!');
        }

        function limparFluxograma() {
            if (!currentData) {
                showError('N√£o h√° fluxograma para limpar');
                return;
            }

            if (confirm('Tem certeza que deseja limpar o fluxograma?')) {
                editor.clear();
                document.getElementById('processo-nome').textContent = '';
                document.getElementById('processo-nome').style.display = 'none';
                document.getElementById('controls').style.display = 'none';
                document.getElementById('excel_file').value = '';
                currentData = null;
                showSuccess('‚úì Fluxograma limpo!');
            }
        }

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '+':
                    case '=':
                        e.preventDefault();
                        editor.zoom_in();
                        break;
                    case '-':
                        e.preventDefault();
                        editor.zoom_out();
                        break;
                    case '0':
                        e.preventDefault();
                        editor.zoom_reset();
                        break;
                }
            }
        });

        // Drag and drop de arquivo
        const uploadSection = document.querySelector('.upload-section');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#00AE9D';
            uploadSection.style.background = '#f0f9f8';
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#00796B';
            uploadSection.style.background = '#f9f9f9';
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#00796B';
            uploadSection.style.background = '#f9f9f9';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('excel_file').files = files;
                uploadFile();
            }
        });
    </script>
</body>
</html>
